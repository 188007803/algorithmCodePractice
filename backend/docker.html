<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker笔记</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/notebook/assets/css/0.styles.53d56f5b.css" as="style"><link rel="preload" href="/notebook/assets/js/app.bf1c7567.js" as="script"><link rel="preload" href="/notebook/assets/js/2.80972f4c.js" as="script"><link rel="preload" href="/notebook/assets/js/10.7b548784.js" as="script"><link rel="prefetch" href="/notebook/assets/js/11.2fa56933.js"><link rel="prefetch" href="/notebook/assets/js/12.852ac34d.js"><link rel="prefetch" href="/notebook/assets/js/13.f9e4403f.js"><link rel="prefetch" href="/notebook/assets/js/14.b4c59f3a.js"><link rel="prefetch" href="/notebook/assets/js/15.8ed446c3.js"><link rel="prefetch" href="/notebook/assets/js/3.971d7898.js"><link rel="prefetch" href="/notebook/assets/js/4.d6a9bfa0.js"><link rel="prefetch" href="/notebook/assets/js/5.ce4e0d43.js"><link rel="prefetch" href="/notebook/assets/js/6.a021a725.js"><link rel="prefetch" href="/notebook/assets/js/7.1636c2b4.js"><link rel="prefetch" href="/notebook/assets/js/8.753c7022.js"><link rel="prefetch" href="/notebook/assets/js/9.af0c9d7f.js">
    <link rel="stylesheet" href="/notebook/assets/css/0.styles.53d56f5b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="vuepress-blog-logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/frontend/vue-element-admin.html" class="nav-link">
  VueElementAdmin调整
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/backend/live-stream.html" class="nav-link">
  直播服务搭建笔记
</a></li><li class="dropdown-item"><!----> <a href="/notebook/backend/rabbit-mq.html" class="nav-link">
  RabbitMQ消息队列
</a></li><li class="dropdown-item"><!----> <a href="/notebook/backend/docker.html" class="nav-link router-link-exact-active router-link-active">
  Docker笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/algorithm/common.html" class="nav-link">
  常用算法
</a></li><li class="dropdown-item"><!----> <a href="/notebook/algorithm/tree.html" class="nav-link">
  二叉树相关
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/frontend/vue-element-admin.html" class="nav-link">
  VueElementAdmin调整
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/backend/live-stream.html" class="nav-link">
  直播服务搭建笔记
</a></li><li class="dropdown-item"><!----> <a href="/notebook/backend/rabbit-mq.html" class="nav-link">
  RabbitMQ消息队列
</a></li><li class="dropdown-item"><!----> <a href="/notebook/backend/docker.html" class="nav-link router-link-exact-active router-link-active">
  Docker笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/algorithm/common.html" class="nav-link">
  常用算法
</a></li><li class="dropdown-item"><!----> <a href="/notebook/algorithm/tree.html" class="nav-link">
  二叉树相关
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/backend/live-stream.html" class="sidebar-link">搭建直播服务器</a></li><li><a href="/notebook/backend/rabbit-mq.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/notebook/backend/docker.html" class="active sidebar-link">Docker笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_01-docker-是什么" class="sidebar-link">01_Docker 是什么</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_02-docker安装" class="sidebar-link">02_Docker安装</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_03-简单nginx服务" class="sidebar-link">03_简单Nginx服务</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_04-docker运行过程" class="sidebar-link">04_Docker运行过程</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_05-定制镜像" class="sidebar-link">05_定制镜像</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_06-定制nodejs镜像" class="sidebar-link">06_定制NodeJS镜像</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_07-pm2镜像" class="sidebar-link">07_PM2镜像</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_08-docker-compose" class="sidebar-link">08_Docker-compose</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_09-前后端分离" class="sidebar-link">09_前后端分离</a></li><li class="sidebar-sub-header"><a href="/notebook/backend/docker.html#_10-持续集成" class="sidebar-link">10_持续集成</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="docker笔记"><a href="#docker笔记" class="header-anchor">#</a> Docker笔记</h1> <h2 id="_01-docker-是什么"><a href="#_01-docker-是什么" class="header-anchor">#</a> 01_Docker 是什么</h2> <ul><li>一次封装，到处执行</li> <li>基于Linux的高效、敏捷、轻量级容器方案。</li></ul> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 下载镜像</span>
<span class="token function">git</span> clone <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>./docker_ci.git

<span class="token comment"># 启动镜像（所有的服务都启动了）</span>
docker-compose up

</code></pre></div><h2 id="_02-docker安装"><a href="#_02-docker安装" class="header-anchor">#</a> 02_Docker安装</h2> <p><a href="https://cloud.tencent.com/developer/article/1405735" target="_blank" rel="noopener noreferrer">腾讯云 ubuntu 系统改为 root 登陆<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># apt升级</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update

<span class="token comment"># 添加相关软件包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    software-properties-common

<span class="token comment"># 下载软件包的合法性，需要添加软件源的 GPG 密钥</span>
<span class="token function">curl</span> -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -


<span class="token comment"># source.list 中添加 Docker 软件源</span>
<span class="token function">sudo</span> add-apt-repository <span class="token punctuation">\</span>
 <span class="token string">&quot;deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu \
 <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> \
 stable&quot;</span>

<span class="token comment"># 安装 Docker CE</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce

<span class="token comment"># 脚本自动安装（不需要）</span>
<span class="token function">curl</span> -fsSL get.docker.com -o get-docker.sh
<span class="token function">sudo</span> <span class="token function">sh</span> get-docker.sh --mirror Aliyun

<span class="token comment"># 启动 Docker CE</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> docker
<span class="token function">sudo</span> systemctl start docker

<span class="token comment"># 建立 docker 用户组（附加）</span>
<span class="token function">sudo</span> <span class="token function">groupadd</span> docker
<span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker <span class="token environment constant">$USER</span>

<span class="token comment"># Helloworld</span>
docker run hello-world

</code></pre></div><p><a href="https://www.jianshu.com/p/7cb39acb2513" target="_blank" rel="noopener noreferrer">启动Docker CE时如果报这个错：perl: warning: Setting locale failed. 的解决方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>镜像加速</p> <ul><li><a href="https://github.com/Azure/container-service-for-azure-china/blob/master/aks/README.md#22-container-registry-proxy" target="_blank" rel="noopener noreferrer">Azure中国镜像 https://dockerhub.azk8s.cn<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://cr.console.aliyun.com/cn-hangzhou/mirrors" target="_blank" rel="noopener noreferrer">阿里云加速器(需登录帐号获取)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kirk-enterprise.github.io/hub-docs/#/user-guide/mirror" target="_blank" rel="noopener noreferrer">七牛云加速器 https://reg-mirror.qiniu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># /etc/docker/daemon.json</span>

<span class="token punctuation">{</span>
	<span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token string">&quot;https://dockerhub.azk8s.cn&quot;</span>,
		<span class="token string">&quot;https://reg-mirror.qiniu.com&quot;</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># 重启docker服务</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker

<span class="token comment"># 测试一下下载速度</span>
docker pull nginx


</code></pre></div><h2 id="_03-简单nginx服务"><a href="#_03-简单nginx服务" class="header-anchor">#</a> 03_简单Nginx服务</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 拉取nginx镜像</span>
docker pull nginx

<span class="token comment"># 查看</span>
docker images nginx

<span class="token comment"># www目录里放一个index.html</span>
<span class="token function">mkdir</span> www
<span class="token builtin class-name">echo</span> <span class="token string">'hello docker!!'</span> <span class="token operator">&gt;&gt;</span> www/index.html

<span class="token comment"># 用 docker 启动 nginx 镜像</span>
<span class="token comment"># 参数： 端口映射：-p 8000:80， 目录映射 -v ....</span>
docker run -p <span class="token number">8000</span>:80 -v <span class="token environment constant">$PWD</span>/www:usr/share/nginx/html nginx

<span class="token comment"># 用 docker 启动 nginx 镜像</span>
<span class="token comment"># 参数： 端口映射：-p 8000:80， 目录映射 -v ....， 守护模式 -d</span>
docker run -p <span class="token number">8000</span>:80 -v <span class="token environment constant">$PWD</span>/www:usr/share/nginx/html -d nginx

<span class="token comment"># 查看docker进程</span>
docker <span class="token function">ps</span>

<span class="token comment"># 查看所有docker进程</span>
docker <span class="token function">ps</span> -a

<span class="token comment"># 停镜像</span>
docker stop <span class="token punctuation">[</span>container ID 前3位<span class="token punctuation">]</span>

<span class="token comment"># 启动镜像</span>
docker start <span class="token punctuation">[</span>container ID 前3位<span class="token punctuation">]</span>


<span class="token comment"># 进入docker内部的伪终端</span>
docker <span class="token builtin class-name">exec</span> -it <span class="token punctuation">[</span>c99<span class="token punctuation">]</span> /bin/bash

<span class="token comment"># 看看刚才映射的目录</span>
<span class="token builtin class-name">cd</span> /usr/share/nginx/html
<span class="token function">cat</span> index.html

<span class="token comment"># 退出docker内部</span>
<span class="token builtin class-name">exit</span>

<span class="token comment"># 停止并删除列表中的镜像（不是删除镜像本身）</span>
docker stop c99
docker <span class="token function">rm</span> c99

</code></pre></div><h2 id="_04-docker运行过程"><a href="#_04-docker运行过程" class="header-anchor">#</a> 04_Docker运行过程</h2> <ul><li><p>镜像 (Image)
面向Docker的只读模板</p></li> <li><p>容器 (Container)
镜像的运行实例</p></li> <li><p>仓库 (Registry)
存储镜像的服务器</p></li></ul> <h2 id="_05-定制镜像"><a href="#_05-定制镜像" class="header-anchor">#</a> 05_定制镜像</h2> <blockquote><p>镜像的定制实际就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是Dockerfile。</p></blockquote> <ul><li><p>定制自己的web服务器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建Dockerfile</span>
FROM nginx:latest
RUN <span class="token builtin class-name">echo</span> <span class="token string">'&lt;h1&gt;Hello, Kaikeba!&lt;/h1&gt;'</span> <span class="token operator">&gt;</span> /usr/share/nginx/html/index.html
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 进入Dockfile所在目录,如:</span>
<span class="token builtin class-name">cd</span> ~/source/docker/nginx

<span class="token comment"># 定制镜像</span>
docker build -t nginx:kaikeba <span class="token builtin class-name">.</span>

<span class="token comment"># 运行</span>
docker run -p <span class="token number">8000</span>:80 nginx:kaikeba
</code></pre></div></li></ul> <h2 id="_06-定制nodejs镜像"><a href="#_06-定制nodejs镜像" class="header-anchor">#</a> 06_定制NodeJS镜像</h2> <h3 id="准备好node和npm"><a href="#准备好node和npm" class="header-anchor">#</a> 准备好node和npm</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装nvm</span>
<span class="token function">wget</span> -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh <span class="token operator">|</span> <span class="token function">bash</span>

<span class="token comment"># 查看可安装node版本</span>
nvm ls-remote

<span class="token comment"># 安装node和npm(最新lts版)</span>
nvm <span class="token function">install</span> --lts

<span class="token comment"># 升级npm</span>
<span class="token function">npm</span> i -g <span class="token function">npm</span>

<span class="token comment"># npm换源</span>
<span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npm.taobao.org

<span class="token comment"># npm源还原</span>
<span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npmjs.org

</code></pre></div><h3 id="开发一个简单koa程序"><a href="#开发一个简单koa程序" class="header-anchor">#</a> 开发一个简单koa程序</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> init -y
<span class="token function">npm</span> i koa -s
<span class="token function">vi</span> app.js
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello NodeJS !!'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app started at 3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>写入Dockerfile</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>12<span class="token punctuation">-</span>alpine
<span class="token keyword">ADD</span> . /app/
<span class="token keyword">WORKDIR</span> /app
<span class="token keyword">RUN</span> npm install
<span class="token keyword">EXPOSE</span> 3000
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>构建镜像</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 定制镜像</span>
docker build -t mynode <span class="token builtin class-name">.</span>

<span class="token comment"># 启动镜像</span>
docker run -p <span class="token number">3000</span>:3000 mynode
</code></pre></div><h2 id="_07-pm2镜像"><a href="#_07-pm2镜像" class="header-anchor">#</a> 07_PM2镜像</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 拷贝一下上节课的node镜像</span>

<span class="token function">cp</span> -R node pm2
<span class="token builtin class-name">cd</span> pm2
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># .dockerignore</span>
node_modules
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code>// proces.yml
<span class="token key atrule">apps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">script</span><span class="token punctuation">:</span> app.js
    <span class="token key atrule">instances</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">watch</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">NODE_ENV</span><span class="token punctuation">:</span> production
</code></pre></div><div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># Dockerfile</span>

<span class="token keyword">FROM</span> keymetrics/pm2<span class="token punctuation">:</span>latest<span class="token punctuation">-</span>alpine
<span class="token keyword">WORKDIR</span> /usr/src/app
<span class="token keyword">ADD</span> . /usr/src/app
<span class="token keyword">RUN</span> npm config set registry https<span class="token punctuation">:</span>//registry.npm.taobao.org/ &amp;&amp; npm i
<span class="token keyword">EXPOSE</span> 3000

<span class="token comment"># pm2 在 docker 中的命令为 pm2-docker</span>
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;pm2-runtime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;process.yml&quot;</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 定制镜像</span>
docker build -t mypm2 <span class="token builtin class-name">.</span>

<span class="token comment"># 启动镜像</span>
docker run -p <span class="token number">3000</span>:3000 -d mypm2
</code></pre></div><h2 id="_08-docker-compose"><a href="#_08-docker-compose" class="header-anchor">#</a> 08_Docker-compose</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 安装 docker-compose</span>
<span class="token function">apt</span> <span class="token function">install</span> docker-compose

<span class="token comment"># 新建 docker-compose</span>
<span class="token function">mkdir</span> helloworld <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> helloworld
<span class="token function">vi</span> docker-compose.yml

</code></pre></div><div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># docker-compose.yml</span>

<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">hello-world</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 启动 docker-compose</span>
docker-compose up
</code></pre></div><p>compose是官方开源项目，负责docker容器集群的快速编排</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># docker-compose.yml</span>
<span class="token comment"># 一次性启动 mongo 和 mongo-express 镜像</span>

<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span>
  <span class="token key atrule">mongo-express</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>express
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8000<span class="token punctuation">:</span><span class="token number">8081</span>

</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>docker-compose up
</code></pre></div><h2 id="_09-前后端分离"><a href="#_09-前后端分离" class="header-anchor">#</a> 09_前后端分离</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 免密登录</span>

<span class="token comment"># 查看我的本机公钥（ 还有对应的私钥 id_rsa ）</span>
<span class="token function">cat</span> ~/.ssh/id_rsa.pub

<span class="token comment"># 如果没有就生成一对（一路回车即可）</span>
ssh-keygen -t rsa     <span class="token punctuation">[</span>-C <span class="token string">&quot;yourEmail&quot;</span><span class="token punctuation">]</span>

<span class="token comment"># 把公钥复制到远程主机上（出来一些提示，并要你输入密码后，就成功了。）</span>
ssh-copy-id -i ~/.ssh/id_rsa.pub root@你的IP地址

<span class="token comment"># 登录</span>
<span class="token function">ssh</span> root@你的IP地址

<span class="token comment"># 给服务器起别名</span>

<span class="token builtin class-name">cd</span> ~/.ssh
<span class="token function">touch</span> config
<span class="token function">vi</span> config

<span class="token comment"># config</span>
Host *
  UseKeychain <span class="token function">yes</span>
Host server1
  HostName <span class="token number">148.157</span>.254.111
  User root

Host server2
  HostName <span class="token number">148.157</span>.254.112
  User root

<span class="token comment"># 用别名登录</span>
<span class="token function">ssh</span> server1

<span class="token comment"># 注意：nodejs的ssh2模块 不能解析 ssh 生成的密钥</span>
<span class="token comment"># 如果用vscode的deploy插件时报这个错：Cannot parse privateKey: Unsupported key format</span>
<span class="token comment"># 你需要将公钥转换格式，或重新生成密钥对</span>

<span class="token comment"># 重新生成</span>
ssh-keygen -m PEM -t rsa

<span class="token comment"># 转换已有的私钥格式 (推荐，注意先备份)</span>
ssh-keygen -p -m PEM -f ~/.ssh/id_rsa


</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 典型的前后分端项目</span>
<span class="token comment"># 包括4个容器 (app-pm2, mongo, mongo-express, nginx)</span>
<span class="token comment"># 其中app-pm2需要自己构建</span>
<span class="token comment"># 其余的直接拉镜像</span>

</code></pre></div><div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token comment"># docker-compose.yml</span>

version<span class="token punctuation">:</span> <span class="token string">'3.1'</span>
services<span class="token punctuation">:</span>
  app<span class="token punctuation">-</span>pm2<span class="token punctuation">:</span>
      container_name<span class="token punctuation">:</span> app<span class="token punctuation">-</span>pm2
      <span class="token comment">#构建容器</span>
      build<span class="token punctuation">:</span> ./backend
      <span class="token comment">#直接从git拉去</span>
      <span class="token comment"># build: git@github.com:su37josephxia/docker_ci.git#:backend</span>
      <span class="token comment"># 需要链接本地代码时</span>
      <span class="token comment"># volumes:</span>
      <span class="token comment">#   - ./backend:/usr/src/app</span>
      ports<span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;3000:3000&quot;</span>
  mongo<span class="token punctuation">:</span>
    image<span class="token punctuation">:</span> mongo
    restart<span class="token punctuation">:</span> always
    ports<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span>27017
  mongo<span class="token punctuation">-</span>express<span class="token punctuation">:</span>
    image<span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>express
    restart<span class="token punctuation">:</span> always
    ports<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8081<span class="token punctuation">:</span>8081
  nginx<span class="token punctuation">:</span>
    restart<span class="token punctuation">:</span> always
    image<span class="token punctuation">:</span> nginx
    ports<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8091<span class="token punctuation">:</span>80
    volumes<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx/conf.d/<span class="token punctuation">:</span>/etc/nginx/conf.d
      <span class="token punctuation">-</span> ./frontend/dist<span class="token punctuation">:</span>/var/www/html/
      <span class="token punctuation">-</span> ./static/<span class="token punctuation">:</span>/static/
</code></pre></div><h2 id="_10-持续集成"><a href="#_10-持续集成" class="header-anchor">#</a> 10_持续集成</h2> <p>git重要技能</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># git push 强制提交</span>
<span class="token function">git</span> push -f origin master

<span class="token comment"># 从远程仓库下载最新版本</span>
<span class="token function">git</span> fetch --all
<span class="token comment"># 将本地设为刚获取的最新的内容(强制覆盖)</span>
<span class="token function">git</span> reset --hard origin/master

</code></pre></div><p>利用webhooks 来持续构建</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webhooks.js</span>
<span class="token comment">// github的webhooks 中要有同样的配置 ( path: '/webhook', secret: 'myhashsecret')</span>

<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> createHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'github-webhook-handler'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/webhook'</span><span class="token punctuation">,</span> secret<span class="token operator">:</span> <span class="token string">'myhashsecret'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'no such location'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">7777</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received *'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received a push event for %s to %s'</span><span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>ref<span class="token punctuation">)</span>

    <span class="token comment">// 分支判断</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>ref <span class="token operator">===</span> <span class="token string">'refs/heads/master'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'deploy master..'</span><span class="token punctuation">)</span>
        <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'./deploy-dev.sh'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'issues'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Received an issue event for %s action=%s: #%d %s'</span><span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>action<span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>issue<span class="token punctuation">.</span>number<span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>issue<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>



<span class="token keyword">function</span> <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> spawn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>spawn<span class="token punctuation">;</span>
    <span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> resp <span class="token operator">+=</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">callback</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>持续构建的布署脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#deploy-dev.sh</span>

<span class="token builtin class-name">echo</span> Deploy Project
<span class="token comment"># docker-compose up -d --force-recreate --build</span>

<span class="token comment"># 获取最新版代码</span>
<span class="token function">git</span> pull

<span class="token comment"># 强制重新编译容器</span>
docker-compose down
docker-compose up -d --force-recreate --build


<span class="token comment"># 定制镜像</span>
<span class="token comment"># docker build -t myapp:pm2 ./backend</span>

<span class="token comment"># 重启启动容器</span>
<span class="token comment"># docker stop myapp</span>
<span class="token comment"># docker rm myapp</span>
<span class="token comment"># docker run --name myapp -p 3000:3000  -d myapp:pm2</span>
</code></pre></div><p>实际经验</p> <div class="language- extra-class"><pre class="language-text"><code>- 改前端dist目录，改动可以立即生效，因为不需要构建。

- 改后端server的内容，却不会立即生效，因为没有引发构建，只有改改docker-compose, 才会引发重新构建

</code></pre></div><h3 id="ubuntu-安装-nginx"><a href="#ubuntu-安装-nginx" class="header-anchor">#</a> ubuntu 安装 nginx</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装nginx</span>
<span class="token variable">$sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx

<span class="token comment"># 更新源</span>
<span class="token variable">$sudo</span> <span class="token function">apt-get</span> update

<span class="token comment"># 更新已安装的包</span>
<span class="token variable">$sudo</span> <span class="token function">apt-get</span> upgrade

<span class="token variable">$sudo</span> /etc/init.d/nginx start <span class="token comment"># 启动</span>
<span class="token variable">$sudo</span> /etc/init.d/nginx stop  <span class="token comment"># 停止</span>
<span class="token variable">$sudo</span> /etc/init.d/nginx restart <span class="token comment"># 重启</span>
<span class="token variable">$sudo</span> /etc/init.d/nginx status <span class="token comment"># 状态</span>

<span class="token comment"># 查看端口占用</span>
<span class="token function">lsof</span> -i:80

<span class="token comment"># 测试nginx.conf文件</span>
/usr/sbin/nginx -t -c /etc/nginx/nginx.conf



</code></pre></div><table><thead><tr><th>名称</th> <th>目录</th></tr></thead> <tbody><tr><td>配置文件</td> <td>/etc/nginx/nginx.conf</td></tr> <tr><td>程序文件</td> <td>/usr/sbin/nginx</td></tr> <tr><td>日志</td> <td>/varlog/nginx</td></tr> <tr><td>默认虚拟主机</td> <td>/var/www/html</td></tr> <tr><td>守护进程程序文件</td> <td>/etc/init.d/nginx</td></tr></tbody></table></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/27/2020, 2:21:41 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notebook/backend/rabbit-mq.html" class="prev">
        RabbitMQ
      </a></span> <span class="next"><a href="/notebook/algorithm/common.html">
        常用算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook/assets/js/app.bf1c7567.js" defer></script><script src="/notebook/assets/js/2.80972f4c.js" defer></script><script src="/notebook/assets/js/10.7b548784.js" defer></script>
  </body>
</html>
