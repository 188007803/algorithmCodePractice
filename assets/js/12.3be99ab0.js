(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{395:function(t,s,n){"use strict";n.r(s);var a=n(19),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"docker笔记"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker笔记"}},[t._v("#")]),t._v(" Docker笔记")]),t._v(" "),n("h2",{attrs:{id:"_01-docker-是什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_01-docker-是什么"}},[t._v("#")]),t._v(" 01_Docker 是什么")]),t._v(" "),n("ul",[n("li",[t._v("一次封装，到处执行")]),t._v(" "),n("li",[t._v("基于Linux的高效、敏捷、轻量级容器方案。")])]),t._v(" "),n("h3",{attrs:{id:"使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("./docker_ci.git\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动镜像（所有的服务都启动了）")]),t._v("\ndocker-compose up\n\n")])])]),n("h2",{attrs:{id:"_02-docker安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_02-docker安装"}},[t._v("#")]),t._v(" 02_Docker安装")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1405735",target:"_blank",rel:"noopener noreferrer"}},[t._v("腾讯云 ubuntu 系统改为 root 登陆"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# apt升级")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加相关软件包")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    apt-transport-https "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    ca-certificates "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    software-properties-common\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载软件包的合法性，需要添加软件源的 GPG 密钥")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" apt-key "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" -\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# source.list 中添加 Docker 软件源")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" add-apt-repository "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu \\\n '),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("lsb_release -cs"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(' \\\n stable"')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装 Docker CE")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" docker-ce\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 脚本自动安装（不需要）")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -fsSL get.docker.com -o get-docker.sh\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" get-docker.sh --mirror Aliyun\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动 Docker CE")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" docker\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl start docker\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 建立 docker 用户组（附加）")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("groupadd")]),t._v(" docker\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("usermod")]),t._v(" -aG docker "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$USER")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Helloworld")]),t._v("\ndocker run hello-world\n\n")])])]),n("p",[n("a",{attrs:{href:"https://www.jianshu.com/p/7cb39acb2513",target:"_blank",rel:"noopener noreferrer"}},[t._v("启动Docker CE时如果报这个错：perl: warning: Setting locale failed. 的解决方案"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("镜像加速")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/Azure/container-service-for-azure-china/blob/master/aks/README.md#22-container-registry-proxy",target:"_blank",rel:"noopener noreferrer"}},[t._v("Azure中国镜像 https://dockerhub.azk8s.cn"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://cr.console.aliyun.com/cn-hangzhou/mirrors",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里云加速器(需登录帐号获取)"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://kirk-enterprise.github.io/hub-docs/#/user-guide/mirror",target:"_blank",rel:"noopener noreferrer"}},[t._v("七牛云加速器 https://reg-mirror.qiniu.com"),n("OutboundLink")],1)])]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /etc/docker/daemon.json")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"registry-mirrors"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://dockerhub.azk8s.cn"')]),t._v(",\n\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://reg-mirror.qiniu.com"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启docker服务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl daemon-reload\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl restart docker\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 测试一下下载速度")]),t._v("\ndocker pull nginx\n\n\n")])])]),n("h2",{attrs:{id:"_03-简单nginx服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_03-简单nginx服务"}},[t._v("#")]),t._v(" 03_简单Nginx服务")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取nginx镜像")]),t._v("\ndocker pull nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看")]),t._v("\ndocker images nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# www目录里放一个index.html")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" www\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello docker!!'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" www/index.html\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用 docker 启动 nginx 镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 参数： 端口映射：-p 8000:80， 目录映射 -v ....")]),t._v("\ndocker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),t._v(":80 -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PWD")]),t._v("/www:usr/share/nginx/html nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用 docker 启动 nginx 镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 参数： 端口映射：-p 8000:80， 目录映射 -v ....， 守护模式 -d")]),t._v("\ndocker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),t._v(":80 -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PWD")]),t._v("/www:usr/share/nginx/html -d nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看docker进程")]),t._v("\ndocker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看所有docker进程")]),t._v("\ndocker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -a\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停镜像")]),t._v("\ndocker stop "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container ID 前3位"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动镜像")]),t._v("\ndocker start "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container ID 前3位"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入docker内部的伪终端")]),t._v("\ndocker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("c99"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" /bin/bash\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 看看刚才映射的目录")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /usr/share/nginx/html\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" index.html\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 退出docker内部")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止并删除列表中的镜像（不是删除镜像本身）")]),t._v("\ndocker stop c99\ndocker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" c99\n\n")])])]),n("h2",{attrs:{id:"_04-docker运行过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_04-docker运行过程"}},[t._v("#")]),t._v(" 04_Docker运行过程")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("镜像 (Image)\n面向Docker的只读模板")])]),t._v(" "),n("li",[n("p",[t._v("容器 (Container)\n镜像的运行实例")])]),t._v(" "),n("li",[n("p",[t._v("仓库 (Registry)\n存储镜像的服务器")])])]),t._v(" "),n("h2",{attrs:{id:"_05-定制镜像"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_05-定制镜像"}},[t._v("#")]),t._v(" 05_定制镜像")]),t._v(" "),n("blockquote",[n("p",[t._v("镜像的定制实际就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是Dockerfile。")])]),t._v(" "),n("ul",[n("li",[n("p",[t._v("定制自己的web服务器")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建Dockerfile")]),t._v("\nFROM nginx:latest\nRUN "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'<h1>Hello, Kaikeba!</h1>'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/share/nginx/html/index.html\n")])])]),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入Dockfile所在目录,如:")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/source/docker/nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定制镜像")]),t._v("\ndocker build -t nginx:kaikeba "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 运行")]),t._v("\ndocker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),t._v(":80 nginx:kaikeba\n")])])])])]),t._v(" "),n("h2",{attrs:{id:"_06-定制nodejs镜像"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_06-定制nodejs镜像"}},[t._v("#")]),t._v(" 06_定制NodeJS镜像")]),t._v(" "),n("h3",{attrs:{id:"准备好node和npm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#准备好node和npm"}},[t._v("#")]),t._v(" 准备好node和npm")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装nvm")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看可安装node版本")]),t._v("\nnvm ls-remote\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装node和npm(最新lts版)")]),t._v("\nnvm "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --lts\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 升级npm")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i -g "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# npm换源")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" config "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry https://registry.npm.taobao.org\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# npm源还原")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" config "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry https://registry.npmjs.org\n\n")])])]),n("h3",{attrs:{id:"开发一个简单koa程序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开发一个简单koa程序"}},[t._v("#")]),t._v(" 开发一个简单koa程序")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" init -y\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i koa -s\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" app.js\n")])])]),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Hello NodeJS !!'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app started at 3000'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("写入Dockerfile")]),t._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("12"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" . /app/\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 3000\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"app.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("p",[t._v("构建镜像")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定制镜像")]),t._v("\ndocker build -t mynode "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动镜像")]),t._v("\ndocker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v(":3000 mynode\n")])])]),n("h2",{attrs:{id:"_07-pm2镜像"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_07-pm2镜像"}},[t._v("#")]),t._v(" 07_PM2镜像")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拷贝一下上节课的node镜像")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" -R node pm2\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" pm2\n")])])]),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .dockerignore")]),t._v("\nnode_modules\n")])])]),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[t._v("// proces.yml\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" app.js\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("instances")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("watch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("NODE_ENV")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" production\n")])])]),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Dockerfile")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" keymetrics/pm2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /usr/src/app\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" . /usr/src/app\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm config set registry https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org/ && npm i\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 3000\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pm2 在 docker 中的命令为 pm2-docker")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pm2-runtime"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"process.yml"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定制镜像")]),t._v("\ndocker build -t mypm2 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动镜像")]),t._v("\ndocker run -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v(":3000 -d mypm2\n")])])]),n("h2",{attrs:{id:"_08-docker-compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_08-docker-compose"}},[t._v("#")]),t._v(" 08_Docker-compose")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装 docker-compose")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" docker-compose\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新建 docker-compose")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" helloworld "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" helloworld\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" docker-compose.yml\n\n")])])]),n("div",{staticClass:"language-yml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yml")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hello-world")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" hello"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("world\n")])])]),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动 docker-compose")]),t._v("\ndocker-compose up\n")])])]),n("p",[t._v("compose是官方开源项目，负责docker容器集群的快速编排")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yml")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 一次性启动 mongo 和 mongo-express 镜像")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mongo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 27017"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("27017")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mongo-express")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 8000"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8081")]),t._v("\n\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker-compose up\n")])])]),n("h2",{attrs:{id:"_09-前后端分离"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_09-前后端分离"}},[t._v("#")]),t._v(" 09_前后端分离")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 免密登录")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看我的本机公钥（ 还有对应的私钥 id_rsa ）")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" ~/.ssh/id_rsa.pub\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果没有就生成一对（一路回车即可）")]),t._v("\nssh-keygen -t rsa     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-C "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yourEmail"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 把公钥复制到远程主机上（出来一些提示，并要你输入密码后，就成功了。）")]),t._v("\nssh-copy-id -i ~/.ssh/id_rsa.pub root@你的IP地址\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 登录")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" root@你的IP地址\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 给服务器起别名")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/.ssh\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" config\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" config\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# config")]),t._v("\nHost *\n  UseKeychain "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yes")]),t._v("\nHost server1\n  HostName "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("148.157")]),t._v(".254.111\n  User root\n\nHost server2\n  HostName "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("148.157")]),t._v(".254.112\n  User root\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用别名登录")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" server1\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注意：nodejs的ssh2模块 不能解析 ssh 生成的密钥")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果用vscode的deploy插件时报这个错：Cannot parse privateKey: Unsupported key format")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 你需要将公钥转换格式，或重新生成密钥对")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重新生成")]),t._v("\nssh-keygen -m PEM -t rsa\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 转换已有的私钥格式 (推荐，注意先备份)")]),t._v("\nssh-keygen -p -m PEM -f ~/.ssh/id_rsa\n\n\n")])])]),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 典型的前后分端项目")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 包括4个容器 (app-pm2, mongo, mongo-express, nginx)")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 其中app-pm2需要自己构建")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 其余的直接拉镜像")]),t._v("\n\n")])])]),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose.yml")]),t._v("\n\nversion"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1'")]),t._v("\nservices"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pm2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      container_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pm2\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#构建容器")]),t._v("\n      build"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./backend\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#直接从git拉去")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# build: git@github.com:su37josephxia/docker_ci.git#:backend")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 需要链接本地代码时")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# volumes:")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   - ./backend:/usr/src/app")]),t._v("\n      ports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3000:3000"')]),t._v("\n  mongo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    image"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo\n    restart"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    ports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 27017"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("27017\n  mongo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    image"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express\n    restart"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    ports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 8081"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("8081\n  nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    restart"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    image"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    ports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 8091"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("80\n    volumes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./nginx/conf.d/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/conf.d\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./frontend/dist"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/www/html/\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./static/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/static/\n")])])]),n("h2",{attrs:{id:"_10-持续集成"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_10-持续集成"}},[t._v("#")]),t._v(" 10_持续集成")]),t._v(" "),n("p",[t._v("git重要技能")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git push 强制提交")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push -f origin master\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 从远程仓库下载最新版本")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" fetch --all\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将本地设为刚获取的最新的内容(强制覆盖)")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" reset --hard origin/master\n\n")])])]),n("p",[t._v("利用webhooks 来持续构建")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// webhooks.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// github的webhooks 中要有同样的配置 ( path: '/webhook', secret: 'myhashsecret')")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" http "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" createHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'github-webhook-handler'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" handler "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/webhook'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" secret"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'myhashsecret'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhttp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("statusCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v("\n    res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'no such location'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7777")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Received *'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Error:'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'push'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Received a push event for %s to %s'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repository"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ref"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 分支判断")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ref "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'refs/heads/master'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'deploy master..'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("run_cmd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sh'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./deploy-dev.sh'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("text")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'issues'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Received an issue event for %s action=%s: #%d %s'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repository"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("issue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("issue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("title"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("run_cmd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("cmd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" spawn "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'child_process'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("spawn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" child "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("spawn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cmd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" resp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    child"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stdout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" resp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    child"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stdout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n")])])]),n("p",[t._v("持续构建的布署脚本")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#deploy-dev.sh")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" Deploy Project\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose up -d --force-recreate --build")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取最新版代码")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" pull\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强制重新编译容器")]),t._v("\ndocker-compose down\ndocker-compose up -d --force-recreate --build\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定制镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker build -t myapp:pm2 ./backend")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启启动容器")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker stop myapp")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker rm myapp")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run --name myapp -p 3000:3000  -d myapp:pm2")]),t._v("\n")])])]),n("p",[t._v("实际经验")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("- 改前端dist目录，改动可以立即生效，因为不需要构建。\n\n- 改后端server的内容，却不会立即生效，因为没有引发构建，只有改改docker-compose, 才会引发重新构建\n\n")])])]),n("h3",{attrs:{id:"ubuntu-安装-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu-安装-nginx"}},[t._v("#")]),t._v(" ubuntu 安装 nginx")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装nginx")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新源")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新已安装的包")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" upgrade\n\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" /etc/init.d/nginx start "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" /etc/init.d/nginx stop  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" /etc/init.d/nginx restart "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$sudo")]),t._v(" /etc/init.d/nginx status "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 状态")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看端口占用")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("lsof")]),t._v(" -i:80\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 测试nginx.conf文件")]),t._v("\n/usr/sbin/nginx -t -c /etc/nginx/nginx.conf\n\n\n\n")])])]),n("table",[n("thead",[n("tr",[n("th",[t._v("名称")]),t._v(" "),n("th",[t._v("目录")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("配置文件")]),t._v(" "),n("td",[t._v("/etc/nginx/nginx.conf")])]),t._v(" "),n("tr",[n("td",[t._v("程序文件")]),t._v(" "),n("td",[t._v("/usr/sbin/nginx")])]),t._v(" "),n("tr",[n("td",[t._v("日志")]),t._v(" "),n("td",[t._v("/varlog/nginx")])]),t._v(" "),n("tr",[n("td",[t._v("默认虚拟主机")]),t._v(" "),n("td",[t._v("/var/www/html")])]),t._v(" "),n("tr",[n("td",[t._v("守护进程程序文件")]),t._v(" "),n("td",[t._v("/etc/init.d/nginx")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);